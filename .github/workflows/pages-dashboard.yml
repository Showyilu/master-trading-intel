name: Deploy Opportunity Dashboard (GitHub Pages)

on:
  workflow_dispatch:
  schedule:
    - cron: "5 */2 * * *"
  push:
    branches: ["main"]
    paths:
      - "scripts/**"
      - "schemas/**"
      - "playbooks/**"
      - "sources/**"
      - "opportunities/**"
      - ".github/workflows/pages-dashboard.yml"

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages-dashboard"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Build live CEX candidates
        run: |
          python scripts/build_live_cex_candidates.py || echo "WARN: CEX build failed, will fallback to last committed/sample data"

      - name: Build network friction model
        run: |
          python scripts/build_network_friction.py || echo "WARN: network friction build failed, using static DEX fee fallback"

      - name: Build live CEX-DEX candidates
        run: |
          python scripts/build_live_cex_dex_candidates.py || echo "WARN: CEX-DEX build failed, continuing"

      - name: Build live funding candidates
        run: |
          python scripts/build_live_funding_candidates.py || echo "WARN: funding build failed, continuing"

      - name: Build live perp-spot basis candidates
        run: |
          python scripts/build_live_basis_candidates.py || echo "WARN: basis build failed, continuing"

      - name: Merge candidate pools
        run: |
          python scripts/merge_candidate_files.py \
            --inputs data/opportunity_candidates.live.json data/opportunity_candidates.cex_dex.live.json data/opportunity_candidates.funding.live.json data/opportunity_candidates.basis.live.json \
            --output data/opportunity_candidates.combined.live.json

      - name: Fallback to sample if merged pool empty
        run: |
          python - <<'PY'
          import json
          from pathlib import Path
          root = Path('.')
          merged = root / 'data/opportunity_candidates.combined.live.json'
          sample = root / 'data/opportunity_candidates.sample.json'
          try:
            payload = json.loads(merged.read_text()) if merged.exists() else []
          except Exception:
            payload = []
          if not isinstance(payload, list) or len(payload) == 0:
            merged.write_text(sample.read_text())
            print('Fallback applied: using sample candidates')
          else:
            print(f'Merged candidates: {len(payload)}')
          PY

      - name: Build execution constraints template
        run: |
          python scripts/build_execution_constraints_template.py \
            --input data/opportunity_candidates.combined.live.json \
            --output data/execution_constraints.latest.json

      - name: Build execution fee table template
        run: |
          python scripts/build_execution_fee_table_template.py \
            --input data/opportunity_candidates.combined.live.json \
            --output data/execution_fee_table.latest.json

      - name: Overlay authenticated venue fees (if secrets available)
        env:
          BINANCE_API_KEY: ${{ secrets.BINANCE_API_KEY }}
          BINANCE_API_SECRET: ${{ secrets.BINANCE_API_SECRET }}
          BYBIT_API_KEY: ${{ secrets.BYBIT_API_KEY }}
          BYBIT_API_SECRET: ${{ secrets.BYBIT_API_SECRET }}
        run: |
          python scripts/build_authenticated_fee_table.py \
            --input-candidates data/opportunity_candidates.combined.live.json \
            --fee-table data/execution_fee_table.latest.json || echo "WARN: authenticated fee overlay failed, using template fee table"

      - name: Score and produce dashboard
        run: |
          python scripts/scan_opportunities.py \
            --input data/opportunity_candidates.combined.live.json \
            --constraints data/execution_constraints.latest.json \
            --fee-table data/execution_fee_table.latest.json \
            --output-json opportunities/shortlist-latest.json \
            --output-md opportunities/dashboard-latest.md

      - name: Build static site
        run: |
          python scripts/build_pages_site.py \
            --shortlist opportunities/shortlist-latest.json \
            --dashboard opportunities/dashboard-latest.md \
            --out-dir site

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: site

  deploy:
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
